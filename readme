
linuxlife

    About
    Showcase
    –ü–æ–∏—Å–∫ –ø–æ —Å–∞–π—Ç—É

üèÜ OpenConnect VPN | –ö–û–†–û–õ–¨ –£–ú–ï–†, –î–ê –ó–î–†–ê–í–°–¢–£–ï–¢ –ö–û–†–û–õ–¨ ü§¥!
2024-04-06
#openconnect  #vpn  #linux 
üèÜ OpenConnect VPN | –ö–û–†–û–õ–¨ –£–ú–ï–†, –î–ê –ó–î–†–ê–í–°–¢–£–ï–¢ –ö–û–†–û–õ–¨ ü§¥!
1. –°—Ç–∞–≤–∏–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã –¥–ª—è OpenConnect v1.2.4

sudo apt update && sudo apt install -y vim nano git build-essential libgnutls28-dev libev-dev autoconf automake libtool libpam0g-dev liblz4-dev libseccomp-dev libreadline-dev libnl-route-3-dev libkrb5-dev libradcli-dev libcurl4-gnutls-dev libcjose-dev libjansson-dev liboath-dev libprotobuf-c-dev libtalloc-dev libhttp-parser-dev protobuf-c-compiler gperf iperf3 lcov libuid-wrapper libpam-wrapper libnss-wrapper libsocket-wrapper gss-ntlmssp haproxy iputils-ping freeradius gawk gnutls-bin iproute2 yajl-tools tcpdump

*–¢–£–¢ –º–æ–∂–Ω–æ –≤ —Ç–µ–æ—Ä–∏–∏ –Ω–µ —Å—Ç–∞–≤–∏—Ç—å iperf3 haproxy freeradius, –Ω–æ —è —Å—Ç–∞–≤–ª—é –≤—Å–µ, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞–ª–æ—Å—å –±–µ–∑ –ø—Ä–æ–±–ª–µ–º
2. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ https://gitlab.com/openconnect/ocserv (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–π—Ç–∏ –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ –ø–æ —Ç–µ–≥—É –∫–∞–∫–∞—è –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è, —Å–µ–π—á–∞—Å 1.2.4)

cd ~ && git clone -b 1.2.4 https://gitlab.com/openconnect/ocserv 

3. –°–æ–±–∏—Ä–∞–µ–º

cd ocserv
autoreconf -fvi
./configure && make
sudo make install

4. –°–∫–∞—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥

cd ~/ocserv/src && wget https://gitlab.com/openconnect/ocserv/-/raw/master/doc/sample.config

5. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∏ –∫–ª—é—á–∏ —Å–µ—Ä–≤–µ—Ä–∞

–ü–µ—Ä–≤—ã–º –¥–µ–ª–æ–º —Å–æ–∑–¥–∞–µ–º —Ç–µ–º–ø–ª–µ–π—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π

nano ca-cert.cfg

–ò –≤—Å—Ç–∞–≤–∏–º —ç—Ç–æ:

# X.509 Certificate options

# The organization of the subject.
organization = "142.54.160.100"

# The common name of the certificate owner.
cn = "Example CA"

# The serial number of the certificate.
serial = 001

# In how many days, counting from today, this certificate will expire. Use -1 if there is no expiration date.
expiration_days = -1

# Whether this is a CA certificate or not
ca

# Whether this certificate will be used to sign data
signing_key

# Whether this key will be used to sign other certificates.
cert_signing_key

# Whether this key will be used to sign CRLs.
crl_signing_key
key encipherment
encryption_key
tls_www_server

–ê —Ç–µ–ø–µ—Ä—å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á–∏:

certtool --generate-privkey > ./ocserv-key.pem

certtool --generate-self-signed --load-privkey ocserv-key.pem --template ca-cert.cfg --outfile ocserv-cert.pem

–ò —Ç–∞–∫–∂–µ —Å–æ–∑–¥–∞–¥–∏–º —Ç–µ–º–ø–ª–µ–π—Ç –¥–ª—è dh.pem

nano dh.conf

–ò –≤—Å—Ç–∞–≤–∏–º —ç—Ç–æ:

key_type = RSA
key_bits = 2048
dh_bits = 2048

–ò –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º dh.pem

certtool --generate-dh-params --load-privkey dh.conf --outfile dh.pem

6. –¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–µ–º –ê–ö–ö–ê–£–ù–¢–´ VPN

–°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å –∫–æ—Ñ–∏–≥–∞–º–∏ –≤–Ω—É—Ç—Ä–∏ ~/ocserv/src

mkdir ./clients

–°–æ–∑–¥–∞–µ–º –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

ocpasswd -c ./clients/ocpasswd dmitry

–ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞, —Ç–∞–∫–∂–µ –∑–∞–ø—É—Å–∫–∞–µ–º —Å –¥—Ä—É–≥–∏–º –∏–º–µ–Ω–µ–º

ocpasswd -c ./clients/ocpasswd test

–ò –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–∞–º —É–∂–µ 2 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

cat ./clients/ocpasswd

7. –¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ–º —Å –∫–æ–Ω—Ñ–∏–≥–æ–º —Å–µ—Ä–≤–µ—Ä–∞

nano ~/ocserv/src/sample.config

–í–°–ï –ü–ê–†–ê–ú–ï–¢–†–´ –ü–†–û–í–ï–†–Ø–ï–ú –ü–û–ò–°–ö–û–ú –ß–¢–û–ë–´ –ù–ï –î–£–ë–õ–ò–†–û–í–ê–õ–ò–°–¨!

server-cert = ocserv-cert.pem
server-key = ocserv-key.pem
dh-params = dh.pem
ca-cert = ocserv-cert.pem

–≠–¢–û –£–î–ê–õ–Ø–ï–ú
#server-cert = /etc/ocserv/server-cert.pem
#server-key = /etc/ocserv/server-key.pem
#server-cert = ../tests/certs/server-cert.pem
#server-key = ../tests/certs/server-key.pem


auth = "plain[passwd=./clients/ocpasswd]"
#auth = "certificate" - –í–´–ë–ò–†–ê–¢–¨ –ß–¢–û-–¢–û –û–î–ù–û! –ª–∏–±–æ pass, –ª–∏–±–æ cert, –∞ —Ç–∞–∫–∂–µ –≤–∞–∂–Ω–æ, —á—Ç–æ —Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏ camouflage –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –µ–≥–æ –Ω–∞–¥–æ –æ—Ç–∫–ª—é—á–∞—Ç—å camouflage = false, –õ–ò–ë–û –ø—ã—Ç–∞—Ç—å—Å—è –ø–æ–¥—Ä—É–∂–∏—Ç—å —Å –¥–≤–æ–π–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –∏ –ø–æ –ø–∞—Ä–æ–ª—é –∏ –ø–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É, —á—Ç–æ –Ω–µ –æ—á–µ–Ω—å —É–¥–æ–±–Ω–æ, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ –∫–æ–º—É-—Ç–æ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –≤ –∫–æ—Ä–ø —Å—Ä–µ–¥–µ

tcp-port = 28855  # –ü–æ—Ä—Ç –∏–∑ –±–æ—Ç–∞!
#udp-port = 443  - –û–¢–†–£–ë–ê–ï–ú udp, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω –Ω–∞–º –Ω–µ –Ω—É–∂–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –º—ã –º–æ—Å–∫–∏—Ä—É–µ–º—Å—è –ø–æ–¥ –≤–µ–± —Ç—Ä–∞—Ñ–∏–∫

compression = true
max-clients = 0
max-same-clients = 2

# –ö–û–ù–§–ò–ì–ò –î–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô –ï–°–õ–ò –ù–£–ñ–ù–´
#config-per-user = /home/debian/ocserv/src/clients/configs

keepalive = 60
try-mtu-discovery = true
idle-timeout = 1200
mobile-idle-timeout = 2400

#–¢—É—Ç –õ–∏–±–æ —Ç–∞–∫
#ipv4-network = 10.18.18.0
#ipv4-netmask = 255.255.255.0
#–õ–∏–±–æ —Ç–∞–∫
ipv4-network = 10.18.18.0/24   # –ù–ê–®–ê –ü–û–î–°–ï–¢–¨! –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ª—é–±—É—é

tunnel-all-dns = true

dns = 8.8.8.8    
dns = 1.1.1.1

# –†–û–£–¢–´ –ú–û–ñ–ï–ú –ó–ê–ö–û–ú–ú–ï–ù–¢–ò–†–û–í–ê–¢–¨ –í–°–ï, –ï–°–õ–ò –û–ù–ò –ù–ê–ú –ù–ï –ù–£–ñ–ù–´, –ï–°–õ–ò –ù–£–ñ–ù–´ - –°–û–ó–î–ê–ô–¢–ï –°–í–û–ô –î–õ–Ø –ù–£–ñ–ù–û–ô –ü–û–î–°–ï–¢–ò
#route = 10.10.10.0/255.255.255.0
#route = 192.168.0.0/255.255.0.0
#route = fef4:db8:1000:1001::/64
#route = default
#no-route = 192.168.5.0/255.255.255.0

#for iOS comment line
#user-profile = profile.xml

camouflage = true
camouflage_secret = "mysecretkluch"

#URL –°–ï–†–í–ï–†–ê –í –ö–õ–ò–ï–ù–¢–ï, –ò –ü–û–ú–ï–ù–Ø–ô–¢–ï –ö–õ–Æ–ß !!! https://142.54.160.100:28855/?mysecretkluch

8. –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é clients/configs –≥–¥–µ –±—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –∫–æ–Ω—Ñ–∏–≥–∏ —Å –Ω—É–∂–Ω—ã–º–∏ IP –∏ –º–∞—Ä—à—Ä—É—Ç–∞–º–∏

nano ./clients/configs/dmitry

explicit-ipv4 = 10.18.18.24
route = 10.17.17.0/24 (–∫ –ø—Ä–∏–º–µ—Ä—É –º–∞—Ä—à—Ä—É—Ç –≤ —Å–æ—Å–µ–¥–Ω—é—é –ø–æ–¥—Å–µ—Ç—å wireguard)

–ò–º—è –∫–æ–Ω—Ñ–∏–≥–æ–≤ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∏–º–µ–Ω–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Ç–æ –µ—Å—Ç—å –¥–ª—è dmitry –±—É–¥–µ—Ç —Ç–∞–∫–∂–µ –∏–º—è ./clients/configs/dmitry
9. –í–∫–ª—é—á–∏–º ipforwarding –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

sudo nano /etc/sysctl.conf

–ü–æ–ø—Ä–∞–≤–∏—Ç—å –≤ –∫–æ–Ω—Ñ–∏–≥–µ:

net.ipv4.ip_forward = 1

–ò –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É:

sudo sysctl -p

10. –°–æ–∑–¥–∞–µ–º –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∞–≤–∏–ª iptables (–í–ù–ò–ú–ê–¢–ï–õ–¨–ù–û –°–ú–û–¢–†–ò–ú –ù–ê–®–£ –ü–û–î–°–ï–¢–¨, –õ–û–ö–ê–õ–¨–ù–´–ô IP, –ò –ü–û–†–¢ –ò–ó –ö–û–ù–§–ò–ì–ê)

sudo nano /etc/systemd/system/ocserv-iptables.service

[Unit]
Before=network.target
[Service]
Type=oneshot

ExecStart=/usr/sbin/iptables -t nat -A POSTROUTING -s 10.18.18.0/24 ! -d 10.18.18.0/24 -j SNAT --to 10.10.10.101
ExecStart=/usr/sbin/iptables -I INPUT -p tcp --dport 28855 -j ACCEPT
ExecStart=/usr/sbin/iptables -I FORWARD -s 10.18.18.0/24 -j ACCEPT
ExecStart=/usr/sbin/iptables -I FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT

ExecStop=/usr/sbin/iptables -t nat -D POSTROUTING -s 10.18.18.0/24 ! -d 10.18.18.0/24 -j SNAT --to 10.10.10.101
ExecStop=/usr/sbin/iptables -D INPUT -p tcp --dport 28855 -j ACCEPT
ExecStop=/usr/sbin/iptables -D FORWARD -s 10.18.18.0/24 -j ACCEPT
ExecStop=/usr/sbin/iptables -D FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT

RemainAfterExit=yes
[Install]
WantedBy=multi-user.target

–ò –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ iptables

sudo systemctl daemon-reload
sudo systemctl enable ocserv-iptables.service
sudo systemctl start ocserv-iptables.service
sudo systemctl status ocserv-iptables.service

11. –ó–∞–ø—É—Å–∫–∞–µ–º OpenConnect Server —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Ç–µ—Å—Ç–∞

  sudo ./ocserv -d 9 -f -c sample.config

12. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è —Å –ø–æ–º–æ—â—å—é –∫–ª–∏–µ–Ω—Ç–æ–≤ –ê–Ω–¥—Ä–æ–∏–¥/iOS –∏ linux

Android/iOS –≤ –ø–æ–∏—Å–∫–µ –≤–≤–æ–¥–∏–º OpenConnect –∏ —Å—Ç–∞–≤–∏–º Cisco AnyConnect –ª–∏–±–æ –Ω–∞—Ç–∏–≤–Ω—ã–π OpenConnect

Linux: –°—Ç–∞–≤–∏–º openconnect –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è - —É—Ç–∏–ª–∏—Ç–∞

sudo openconnect https://142.54.160.100:28855/?mysecretkluch

–ï—â–µ –≤–∞—Ä–∏–∞–Ω—Ç GUI:
–î–ª—è gnome –ª—É—á—à–µ –ø–ª–∞–≥–∏–Ω–æ–º networkmanager-openconnect –∏–ª–∏ –ª—é–±—ã–º openconnect GUI

13. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞ camouflage

–û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –±—Ä–∞—É–∑–µ—Ä–µ https://142.54.160.100:28855/
14. –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å ocserv (–ú–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –≤ ExecStart —Ñ–ª–∞–≥ -d 9, —á—Ç–æ–±—ã –ø–∏—Å–∞–ª–æ—Å—å –º–µ–Ω—å—à–µ –ª–æ–≥–æ–≤, –ª–∏–±–æ –≤—ã—Å—Ç–∞–≤–∏—Ç—å -d 4)

sudo nano /etc/systemd/system/ocserv.service

[Unit]
After=network.target
[Service]
WorkingDirectory=/home/debian/ocserv/src
Type=simple
ExecStart=/home/debian/ocserv/src/ocserv -d 9 -f -c /home/debian/ocserv/src/sample.config
ExecStop=/bin/kill $(cat /run/ocserv.pid)
Restart=on-failure
[Install]
WantedBy=multi-user.target

–ò –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤

sudo systemctl daemon-reload
sudo systemctl enable ocserv.service
sudo systemctl start ocserv.service
sudo systemctl status ocserv.service

